<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dino Warp Fixed</title>
    <style>
        body { margin: 0; background: #f7f7f7; overflow: hidden; font-family: 'Courier New', Courier, monospace; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { background: transparent; border-bottom: 2px solid #535353; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800; canvas.height = 350;

        // Assets
        const audPath = 'audio/';
        const snd1k = new Audio(audPath + 'aplausos_2.mp3');
        const snd10k = new Audio(audPath + '-audiotrimmer_adesehy.mp3');
        const sndGameOver = new Audio(audPath + 'directed-by-robert-b_voI2Z4T.mp3');
        const sndWhoosh = new Audio(audPath + 'slowmo_whoosh.mp3');

        const imgPath = 'images/';
        const dinoImg = new Image(); dinoImg.src = imgPath + 'Screenshot_2025-12-27-14-38-59-263_com.android.chrome-edit.jpg';
        const cactusImg = new Image(); cactusImg.src = imgPath + 'Screenshot_2025-12-27-14-52-08-378_com.android.chrome-edit.jpg';

        // Game State
        let score = 0;
        let gameSpeed = 5;
        let isGameOver = false;
        let gameStarted = false;
        let frameCount = 0;
        let highScore = localStorage.getItem('dinoHighScore') || 0;

        // Cheats & FX
        let canFly = false, isInvincible = false, isSlowMo = false;
        let spaceCount = 0, lastSpaceTime = 0, warpFlash = 0, lightningFlash = 0;
        let ghosts = []; // For the ghost trail

        const dino = { x: 50, y: 220, dy: 0, w: 45, h: 45, groundY: 220 };
        let obstacles = [], clouds = [], rain = [], ripples = [];

        // Init Environment
        for(let i=0; i<6; i++) clouds.push({ x: Math.random()*800, y: 30+Math.random()*80, s: 0.5+Math.random() });
        for(let i=0; i<40; i++) rain.push({ x: Math.random()*800, y: Math.random()*350, l: 15 });

        function resetGame() {
            score = 0; gameSpeed = 5; isGameOver = false; obstacles = []; 
            canFly = false; isInvincible = false; isSlowMo = false;
            dino.y = dino.groundY; dino.dy = 0;
        }

        function spawnObstacle() {
            if (frameCount % 70 === 0) {
                let type = Math.random() > 0.3 ? 'cactus' : 'bird';
                obstacles.push({
                    x: 850,
                    y: type === 'cactus' ? 220 : 150 - (Math.random()*100),
                    w: type === 'cactus' ? 30 : 40,
                    h: type === 'cactus' ? 45 : 20,
                    type: type
                });
            }
        }

        function update() {
            if (!gameStarted || isGameOver) return;
            frameCount++;

            let effectiveSpeed = isSlowMo ? gameSpeed * 0.2 : gameSpeed;
            score += canFly ? 5 : 0.15;

            // Audio Milestones
            if (Math.floor(score) === 1000) snd1k.play();
            if (Math.floor(score) === 10000) snd10k.play();

            // Physics
            if (!canFly) {
                dino.dy += 0.6;
                dino.y += dino.dy;
                if (dino.y > dino.groundY) { dino.y = dino.groundY; dino.dy = 0; }
            }

            // Background Cycles
            let cycle = (Math.sin((score / 2000) * Math.PI - (Math.PI / 2)) + 1) / 2;
            let isNight = cycle > 0.6;
            let isStorming = (canFly && isNight && !isSlowMo);
            if (isStorming && Math.random() > 0.98) lightningFlash = 4;
            if (lightningFlash > 0) lightningFlash--;
            if (warpFlash > 0) warpFlash--;

            document.body.style.backgroundColor = lightningFlash > 0 ? '#fff' : (isSlowMo ? '#e6f0ff' : getSkyColor(cycle));

            // Move Obstacles
            obstacles.forEach((obs, i) => {
                obs.x -= effectiveSpeed;
                if (obs.x < -50) obstacles.splice(i, 1);
                
                // Collision
                if (!isInvincible && 
                    dino.x < obs.x + obs.w && dino.x + dino.w > obs.x &&
                    dino.y < obs.y + obs.h && dino.y + dino.h > obs.y) {
                    isGameOver = true;
                    sndGameOver.play();
                }
            });

            // Warp Speed increase
            if (!isSlowMo) gameSpeed += canFly ? 0.2 : 0.001;

            spawnObstacle();
            draw(cycle, isNight, isStorming);
            requestAnimationFrame(update);
        }

        function getSkyColor(c) {
            let r = 247 - (c * 227), g = 247 - (c * 227), b = 247 - (c * 207);
            return `rgb(${r},${g},${b})`;
        }

        function draw(cycle, isNight, isStorming) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Sun/Moon
            const angle = (cycle * Math.PI) + Math.PI;
            const size = canFly ? 40 : 25;
            ctx.fillStyle = isNight ? "#eee" : "#FFD700";
            ctx.beginPath();
            ctx.arc(400 + Math.cos(angle)*300, 150 + Math.sin(angle)*100, size, 0, Math.PI*2);
            ctx.fill();

            // Clouds
            ctx.fillStyle = isNight ? "#666" : "#ddd";
            clouds.forEach(c => {
                c.x -= c.s * (canFly ? 5 : 1);
                if (c.x < -100) c.x = 850;
                ctx.beginPath(); ctx.arc(c.x, c.y, 20, 0, Math.PI*2); ctx.fill();
            });

            // Storm
            if (isStorming) {
                ctx.strokeStyle = "rgba(180, 200, 255, 0.5)";
                rain.forEach(r => {
                    r.x -= 10; r.y += 15;
                    if (r.y > 350) { r.y = -20; r.x = Math.random()*800; }
                    ctx.beginPath(); ctx.moveTo(r.x, r.y); ctx.lineTo(r.x-5, r.y+10); ctx.stroke();
                });
            }

            // Dino Trail
            if (canFly) {
                ghosts.push({y: dino.y, a: 0.5});
                if (ghosts.length > 5) ghosts.shift();
                ghosts.forEach((g, i) => {
                    ctx.globalAlpha = g.a * (i/5);
                    ctx.drawImage(dinoImg, dino.x - (i*10), g.y, dino.w, dino.h);
                });
                ctx.globalAlpha = 1;
            }

            // Dino
            if (isNight && lightningFlash <= 0) ctx.filter = 'invert(1)';
            ctx.drawImage(dinoImg, dino.x, dino.y, dino.w, dino.h);
            
            // Obstacles
            obstacles.forEach(obs => {
                if (obs.type === 'cactus') ctx.drawImage(cactusImg, obs.x, obs.y, obs.w, obs.h);
                else { ctx.fillStyle = "#535353"; ctx.fillRect(obs.x, obs.y, obs.w, obs.h); }
            });
            ctx.filter = 'none';

            // UI
            ctx.fillStyle = isNight ? "#eee" : "#535353";
            ctx.font = "20px Courier New";
            ctx.fillText(`HI ${Math.floor(highScore)} ${Math.floor(score)}`, 600, 30);
            
            if (warpFlash > 0) {
                ctx.fillStyle = `rgba(255,255,255,${warpFlash/10})`;
                ctx.fillRect(0,0,800,350);
            }
            
            if (isGameOver) {
                ctx.fillText("GAME OVER - PRESS R", 300, 180);
            }
        }

        window.addEventListener('keydown', e => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                if (!gameStarted) { gameStarted = true; update(); }
                if (dino.y >= dino.groundY && !canFly) dino.dy = -12;
                
                // Secret Warp Trigger
                let now = Date.now();
                if (now - lastSpaceTime < 300) spaceCount++; else spaceCount = 1;
                lastSpaceTime = now;
                if (spaceCount >= 3 && !canFly) {
                    canFly = true; isInvincible = true; gameSpeed = 50; warpFlash = 10;
                }
            }
            if (e.code === 'KeyR') {
                if (isGameOver) location.reload();
                else if (canFly) {
                    sndWhoosh.play();
                    canFly = false; isInvincible = false; isSlowMo = true;
                    gameSpeed = 7;
                    setTimeout(() => isSlowMo = false, 2000);
                }
            }
            if (canFly) {
                if (e.code === 'ArrowUp') dino.y -= 40;
                if (e.code === 'ArrowDown') dino.y += 40;
            }
        });

        // Final check to start loop if space is pressed
        ctx.fillStyle = "#535353";
        ctx.font = "20px Courier New";
        ctx.fillText("PRESS SPACE TO START", 280, 180);
    </script>
</body>
</html>
